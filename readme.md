# Discord 更新推流机器人 (Update Feed Bot)

一个功能强大的 Discord 机器人，旨在帮助服务器内的创作者（如Mod作者、开发者、艺术家）更方便地向其关注者推送更新。它专为 Discord 的**论坛频道**设计，允许用户订阅特定帖子的更新，或关注某个作者的所有动态。

## ✨ 主要功能

- **帖子订阅**: 用户可以针对性地订阅某个帖子的“发行版”或“测试版”更新。
- **作者关注**: 用户可以关注自己喜欢的创作者，当该作者在指定论坛发布新帖子或更新帖子时，用户会收到通知。
- **🚀【New】主动式帖子追踪**: 机器人能自动检测在指定论坛频道中创建的新帖子，并主动询问作者是否需要为其开启更新推流功能，简化了初始设置流程。
- **灵活的通知系统**: 更新时会向所有订阅者和关注者发送通知。
- **强大的私信控制面板**: 每个用户都可以通过与机器人私信，使用一个交互式的控制面板来：
  - **分类查看更新**: 将“订阅的帖子更新”与“关注的作者动态”分开展示，信息一目了然。
  - **精细化管理**: 支持选择性地将部分或全部更新**标记为已读**。
  - **高效管理列表**: 查看并取消所有已订阅的帖子或已关注的作者，列表支持**高效分页**，即使数据量巨大也不会卡顿。
- **管理员工具**: 提供查询机器人实时运行状态（CPU、内存、延迟等）的管理指令。
- **高性能架构**:
  - **异步优先**: 全面采用 `aiomysql` 异步数据库驱动，避免了数据库操作阻塞，响应更迅速。
  - **持久化存储**: 所有订阅和关注关系都存储在 MySQL 数据库中，确保数据安全。
- **容器化部署**: 使用 Docker 和 Docker Compose, 实现一键部署和轻松维护。

## 🚀 指令列表

| 指令 | 目标用户 | 描述 | 使用范围 |
| :--- | :--- | :--- | :--- |
| `/创建更新推流` | 帖子作者 | 在一个论坛帖子内创建订阅和关注按钮，开启该帖子的更新功能。(现在机器人也会在新帖子创建时自动提示) | 指定的论坛频道 |
| `/更新推流` | 帖子作者 | 向所有订阅该帖子或关注该作者的用户推送一条更新通知。 | 已开启更新的帖子 |
| `/控制面板` | 所有用户 | 打开功能更强大的私人订阅管理中心，分类查看更新、管理订阅和关注。 | 与机器人的私信 |
| `/bot 运行状态` | 机器人管理员 | 查询机器人当前的 CPU、内存、运行时长等详细状态。 | 服务器内 |

## 🛠️ 安装与部署

本项目设计为使用 Docker 进行部署，简化环境配置的复杂性。

### 先决条件

- [Git](https://git-scm.com/)
- [Docker](https://www.docker.com/products/docker-desktop/)
- [Docker Compose](https://docs.docker.com/compose/install/)

### 配置步骤

1.  **克隆仓库**
    ```bash
    git clone <你的仓库URL>
    cd <仓库目录>
    ```

2.  **创建 Discord Bot**
    - 前往 [Discord Developer Portal](https://discord.com/developers/applications)。
    - 点击 "New Application" 创建一个新的应用。
    - 进入 "Bot" 页面，点击 "Add Bot"。
    - **获取 Token**: 在 Bot 页面点击 "Reset Token" 来获取你的机器人令牌。**这是非常敏感的信息，绝对不要泄露给任何人！**
    - **开启特权意图 (Privileged Intents)**: 无需开启任何特权意图。代码中仅使用了默认的 `Intents.default()`，这符合最小权限原则。

3.  **邀请机器人到你的服务器**
    - 在 Developer Portal 中，进入 "OAuth2" -> "URL Generator"。
    - 在 "Scopes" 中选择 `bot` 和 `applications.commands`。
    - 在 "Bot Permissions" 中，授予以下必要的权限：
      - `View Channels`
      - `Send Messages`
      - `Send Messages in Threads`
      - `Embed Links`
      - `Read Message History`
    - 复制生成的URL，在浏览器中打开，然后将机器人邀请到你的目标服务器。

4.  **配置环境变量**
    - 将项目中的 `.env.example` 文件复制一份，并重命名为 `.env`。
    - 使用文本编辑器打开 `.env` 文件，并根据文件内的注释填入你自己的配置信息。这包括：
      - 你的 Discord Bot Token (`DISCORD_TOKEN`)
      - 你的服务器 ID (`TARGET_GUILD_ID`)
      - 机器人管理员的用户 ID (`ADMIN_IDS`)
      - 允许使用机器人的论坛频道 ID (`ALLOWED_CHANNELS`)
      - **【新】** 新帖子追踪相关的设置 (`TRACK_NEW_THREAD_...`)
      - 数据库密码等。

### 运行机器人

1.  **启动服务**
    在你的项目根目录下，运行以下命令来构建并启动机器人和数据库容器：
    ```bash
    docker-compose up -d --build
    ```
    Docker Compose 会自动拉取 MySQL 镜像，构建机器人镜像，并创建持久化数据卷。

2.  **查看日志**
    如果你想查看机器人的实时输出或排查问题，可以使用以下命令：
    ```bash
    docker-compose logs -f app
    ```
    (其中 `app` 是 `docker-compose.yml` 中定义的机器人服务名)

3.  **停止服务**
    要停止机器人和数据库，运行：
    ```bash
    docker-compose down
    ```
    使用 `-v` 选项会删除数据库数据卷，请谨慎操作：`docker-compose down -v`。

## 🏛️ 核心架构升级 (新版)

- **从 `mysql.connector` 到 `aiomysql`**: 新版本已从同步的数据库驱动迁移到完全异步的 `aiomysql`。这意味着所有数据库操作都成为非阻塞的，当机器人在等待数据库返回结果时，可以继续处理其他来自 Discord 的事件，从而大幅提升了机器人的并发处理能力和响应速度。

- **高效分页与按需加载**: 旧版的管理面板会一次性从数据库中抓取用户的所有订阅/关注数据，当数据量大时会导致严重的性能问题和内存占用。新版已重构此逻辑，**每次只从数据库请求当前页面所需的数据**，实现了真正的高效分页，保证了在任何数据规模下的流畅体验。

- **优化的数据库模式**: 引入了 `follower_thread_notifications` 表，用于专门处理对作者关注者的更新通知。这种“收件箱”模式比旧版通过更新每个关注者行状态的方式更为高效和可扩展。

## ⚠️ 重要风险提示

### 幽灵提及 (Ghost Ping) 的滥用风险

`/更新推流` 功能通过在短时间内发送并删除包含用户提及的消息（即“幽灵提及”）来通知用户。

- **高风险**: **此行为极易被 Discord 的 API 速率限制系统检测为滥用行为**。如果通知的用户数量庞大，高频率的 API 调用（发送、删除、编辑）可能导致你的机器人被 **临时甚至永久封禁**。
- **建议**:
  1.  **谨慎使用**: 在 `.env` 文件中将 `UPDATE_MENTION_MAX_NUMBER` 设置为一个较小的值（如 `50`），并确保 `UPDATE_MENTION_DELAY` 有一个合理的延迟（如 `1000` 毫秒）。
  2.  **替代方案**: 最安全、最稳定的通知方式是通过 **私信** 通知用户。本机器人已包含功能完善的私信面板，用户可以通过“查看更新”按钮主动拉取信息。

### 数据库 `ON DELETE CASCADE` 风险

代码中的数据库表结构使用了 `ON DELETE CASCADE` 级联删除。此功能虽然方便，但也存在风险：当一个核心记录被删除时（例如一个用户或一个帖子被从数据库中移除），所有相关的订阅记录也会被自动删除。请确保你了解其工作方式，并定期备份你的数据库。

---

## 许可证 (License)

该项目采用 **知识共享署名-相同方式共享 4.0 国际许可协议 (CC BY-SA 4.0)** 进行许可。

[![CC BY-SA 4.0][cc-by-sa-shield]][cc-by-sa]

这意味着您可以自由地：
- **共享** — 在任何媒介以任何形式复制、发行本作品。
- **演绎** — 修改、转换或以本作品为基础进行创作，在任何用途下，甚至商业用途。

只要您遵守下列许可条款：
- **署名 (Attribution)** — 您必须给出适当的署名，提供指向本许可协议的链接，同时标明是否对原始作品作了修改。
- **相同方式共享 (ShareAlike)** — 如果您再混合、转换、或者基于本作品进行创作，您必须基于与原先许可协议相同的许可协议分发您的贡献。

详情请参阅 [CC BY-SA 4.0 许可协议全文](http://creativecommons.org/licenses/by-sa/4.0/)。

[cc-by-sa]: http://creativecommons.org/licenses/by-sa/4.0/
[cc-by-sa-shield]: https://img.shields.io/badge/License-CC%20BY--SA%204.0-lightgrey.svg